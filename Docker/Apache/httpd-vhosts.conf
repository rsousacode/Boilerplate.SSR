<VirtualHost *:*>
    RequestHeader set "X-Forwarded-Proto" expr=%{REQUEST_SCHEME}s
</VirtualHost>

<VirtualHost *:80>
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule (.*) https://%{HTTP_HOST}%{REQUEST_URI}
</VirtualHost>

<VirtualHost *:443>
    SSLProxyEngine On
    SSLEngine On
    ProxyPreserveHost On
    
    # Swagger (comment in prod)
    #ProxyPass /swagger http://host.docker.internal:5010/swagger
    #ProxyPassReverse /swagger http://host.docker.internal:5010/swagger

    # API 
    ProxyPass "/api" "http://host.docker.internal:5010/api"
    ProxyPassReverse "/api" "http://host.docker.internal:5010/api"
    
    # Frontend (Svelte Kit)
    ProxyPass / http://host.docker.internal:44405/
    ProxyPassReverse / http://host.docker.internal:44405/

    # Frontend websockets (Development only)
    # see https://socket.io/docs/v4/reverse-proxy/#apache-httpd
    
    RewriteEngine on
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteCond %{HTTP:Connection} upgrade [NC]
    RewriteRule ^/?(.*) "ws://host.docker.internal:44405/$1" [P,L]

    ProxyTimeout 30000
    
    # SSL and Error settings
    ServerName ${SERVER_NAME}
    ServerAlias ${SERVER_ALIAS}
    
    ErrorLog /usr/local/apache2/logs/site-error.log
    CustomLog /usr/local/apache2/logs/site-access.log common
    
    SSLCertificateFile /usr/local/apache2/conf/extra/server.crt
    SSLCertificateKeyFile /usr/local/apache2/conf/extra/server.key

</VirtualHost>


